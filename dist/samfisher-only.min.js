/*! Sam Fisher Motion Detection 1.0.0, Copyright 2015 Colin Clark | github.com/colinbdclark/samfisher*/
var fisher=fisher||{};!function(){"use strict";fisher.countPixels=function(a){return a.height*a.width},fisher.buffer=function(a,b){var c=fisher.countPixels(b),d=a*c;return new Uint8ClampedArray(d)},fisher.createColourImageBuffer=function(a){for(var b=fisher.buffer(4,a),c=3;c<b.length;c+=4)b[c]=255;return b},fisher.luminance=function(a,b){return.2126*b[a]+.7152*b[a+1]+.0722*b[a+2]},fisher.greyscale=function(a,b){for(var c=0;c<b.length;c++)b[c]=fisher.luminance(4*c,a)},fisher.difference=function(a,b,c){return Math.abs(c[a]-b[a])},fisher.filter={},fisher.filter.gaussianBoxBlur=function(a,b,c,d){ivank.gaussianBoxBlur(b,c,d.width,d.height,a)},fisher.filter.convolve=function(a,b,c,d){for(var e,f=Math.sqrt(a.length),g=Math.floor(f/2),h=d.height,i=d.width,j=g;h-g-1>j;j++)for(var k=g;i-g-1>k;k++){e=0;for(var l=0;f>l;l++)for(var m=j+l-g,n=m*i,o=0;f>o;o++){var p=n+(k+o-g),q=l*f+o;e+=b[p]*a[q]}var r=j*i+k;c[r]=e}},fisher.filter.mean=function(a,b,c){return fisher.filter.convolve(fisher.filter.mean.kernel,a,b,c)},fisher.filter.mean.kernel=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9]}();var fluid=fluid||require("infusion"),fisher=fisher||{};!function(){"use strict";fluid.defaults("fisher.frameScheduler",{gradeNames:"berg.scheduler",freq:15,components:{clock:{type:"berg.clock.raf"}}})}();var fluid=fluid||require("infusion"),fisher=fisher||{};!function(){"use strict";fluid.defaults("fisher.canvas",{gradeNames:"fluid.component",dimensions:{height:240,width:320},members:{element:{expander:{funcName:"fisher.canvas.createCanvas",args:["{that}.options.markup","{that}.options.dimensions"]}},context:{expander:{"this":"{that}.element",method:"getContext",args:"2d"}}},invokers:{drawElement:"fisher.canvas.drawElement({that}, {arguments}.0)",getPixels:"fisher.canvas.getPixels({that})",putPixels:"fisher.canvas.putPixels({that}, {arguments}.0, {arguments}.1, {arguments}.2)",putMonochromePixels:"fisher.canvas.putMonochromePixels({that}, {arguments}.0, {arguments}.1, {arguments}.2)"},markup:{canvas:"<canvas height='%height' width='%width'></canvas>"}}),fisher.canvas.createCanvas=function(a,b){return $(fluid.stringTemplate(a.canvas,b))[0]},fisher.canvas.drawElement=function(a,b){a.context.drawImage(b,0,0,a.options.dimensions.width,a.options.dimensions.height)},fisher.canvas.getPixels=function(a){return a.context.getImageData(0,0,a.options.dimensions.width,a.options.dimensions.height).data},fisher.canvas.putPixels=function(a,b,c,d){var e=a.options.dimensions;c=c||0,d=d||0;var f=new ImageData(b,e.width,e.height);a.context.putImageData(f,c,d)},fisher.canvas.putMonochromePixels=function(a,b,c,d){for(var e=fisher.canvas.getPixels(a),f=0;f<b.length;f++){var g=4*f,h=b[f];e[g]=h,e[g+1]=h,e[g+2]=h,e[g+3]=255}fisher.canvas.putPixels(a,e,c,d)}}();var fluid=fluid||require("infusion"),fisher=fisher||{};!function(){"use strict";navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,fluid.defaults("fisher.liveVideo",{gradeNames:"fluid.modelComponent",constraints:{video:!0,audio:!1},members:{element:"@expand:fisher.liveVideo.createVideo()"},events:{onStreamOpen:null,onReady:null,onError:null},listeners:{onCreate:["fisher.liveVideo.openStream({that})"],onStreamOpen:["fisher.liveVideo.connectStreamToVideo({that}, {arguments}.0)","{that}.events.onReady.fire()"]}}),fisher.liveVideo.createVideo=function(){return document.createElement("video")},fisher.liveVideo.openStream=function(a){navigator.getMedia(a.options.constraints,a.events.onStreamOpen.fire,a.events.onError.fire)},fisher.liveVideo.connectStreamToVideo=function(a,b){a.element.src=window.URL.createObjectURL(b),a.element.play()}}();var ivank=ivank||{};!function(){"use strict";function a(a,b){var c=Math.sqrt(12*a*a/b+1),d=Math.floor(c);d%2===0&&d--;for(var e=d+2,f=(12*a*a-b*d*d-4*b*d-3*b)/(-4*d-4),g=Math.round(f),h=[],i=0;b>i;i++)h.push(g>i?d:e);return h}function b(a,b,e,f,g){for(var h=0;h<a.length;h++)b[h]=a[h];c(b,a,e,f,g),d(a,b,e,f,g)}function c(a,b,c,d,e){for(var f=1/(e+e+1),g=0;d>g;g++){for(var h=g*c,i=h,j=h+e,k=a[h],l=a[h+c-1],m=(e+1)*k,n=0;e>n;n++)m+=a[h+n];for(n=0;e>=n;n++)m+=a[j++]-k,b[h++]=Math.round(m*f);for(n=e+1;c-e>n;n++)m+=a[j++]-a[i++],b[h++]=Math.round(m*f);for(n=c-e;c>n;n++)m+=l-a[i++],b[h++]=Math.round(m*f)}}function d(a,b,c,d,e){for(var f=1/(e+e+1),g=0;c>g;g++){for(var h=g,i=h,j=h+e*c,k=a[h],l=a[h+c*(d-1)],m=(e+1)*k,n=0;e>n;n++)m+=a[h+n*c];for(n=0;e>=n;n++)m+=a[j]-k,b[h]=Math.round(m*f),j+=c,h+=c;for(n=e+1;d-e>n;n++)m+=a[j]-a[i],b[h]=Math.round(m*f),i+=c,j+=c,h+=c;for(n=d-e;d>n;n++)m+=l-a[i],b[h]=Math.round(m*f),i+=c,h+=c}}ivank.gaussianBoxBlur=function(c,d,e,f,g){var h=a(g,3);b(c,d,e,f,(h[0]-1)/2),b(d,c,e,f,(h[1]-1)/2),b(c,d,e,f,(h[2]-1)/2)}}();var fluid=fluid||require("infusion"),fisher=fisher||{};!function(){"use strict";fluid.defaults("fisher.trackedRegion",{gradeNames:"fluid.component",frameDimensions:{height:240,width:320},dimensions:{height:240,width:320,xOffset:0,yOffset:0},numChannels:4,numPixels:{expander:{funcName:"fisher.countPixels",args:["{that}.options.dimensions"]}},invokers:{motionIndex:{funcName:"fisher.trackedRegion.motionIndex",args:["{arguments}.0","{arguments}.1","{that}.options"]}}}),fisher.trackedRegion.motionIndex=function(a,b,c){for(var d,e,f,g=c.dimensions,h=g.yOffset+g.height,i=0,j=g.yOffset;h>j;j++){d=c.frameDimensions.width*j+g.xOffset,e=d+g.width;for(var k=d;e>k;k++)f=fisher.difference(k,a,b),f>=c.threshold&&i++}return i/c.numPixels},fluid.defaults("fisher.trackedRegion.leftHalf",{gradeNames:"fisher.trackedRegion",dimensions:{height:240,width:160,xOffset:0,yOffset:0}}),fluid.defaults("fisher.trackedRegion.rightHalf",{gradeNames:"fisher.trackedRegion",dimensions:{height:240,width:160,xOffset:160,yOffset:0}})}();var fluid=fluid||require("infusion"),fisher=fisher||{};!function(){"use strict";fluid.defaults("fisher.motionTracker",{gradeNames:"fluid.modelComponent",threshold:Math.round(51),dimensions:{width:320,height:240},members:{current:"@expand:fisher.buffer(1, {that}.options.dimensions)",working:"@expand:fisher.buffer(1, {that}.options.dimensions)",previous:"@expand:fisher.buffer(1, {that}.options.dimensions)"},distributeOptions:[{target:"{that fisher.trackedRegion}.options.frameDimensions",source:"{that}.options.dimensions"},{target:"{that fisher.trackedRegion}.options.threshold",source:"{that}.options.threshold"}],components:{scheduler:{type:"fisher.frameScheduler"},streamer:{type:"fisher.liveVideo"},canvas:{type:"fisher.canvas",options:{dimensions:"{that}.options.dimensions"}},frameTracker:{type:"fisher.frameTracker.stereo"}},events:{onMotionUpdate:"{frameTracker}.events.onMotionUpdate",onNextFrame:null},listeners:{onNextFrame:["{canvas}.drawElement({that}.streamer.element)","fisher.motionTracker.track({that})"],onCreate:["{scheduler}.start()","{scheduler}.repeat({scheduler}.options.freq, {that}.events.onNextFrame.fire)"]}}),fisher.motionTracker.calcNumPixels=function(a){return a.height*a.width},fisher.motionTracker.track=function(a){var b=a.canvas.getPixels();fisher.greyscale(b,a.working),fisher.filter.mean(a.working,a.current,a.options.dimensions),a.frameTracker.track(a.current,a.previous),a.previous.set(a.current)},fluid.defaults("fisher.frameTracker",{gradeNames:"fluid.component",invokers:{track:{funcName:"fluid.notImplemented"}},events:{onMotionUpdate:null}}),fluid.defaults("fisher.frameTracker.mono",{gradenames:"fisher.frameTracker",components:{region:{type:"fisher.trackedRegion"}},invokers:{track:{funcName:"fisher.frameTracker.mono.track",args:["{that}","{arguments}.0","{arguments}.1"]}}}),fisher.frameTracker.mono.track=function(a,b,c){var d=a.region.motionIndex(b,c);a.events.onMotionUpdate.fire(d)},fluid.defaults("fisher.frameTracker.stereo",{gradeNames:"fisher.frameTracker",components:{leftRegion:{type:"fisher.trackedRegion.leftHalf"},rightRegion:{type:"fisher.trackedRegion.rightHalf"}},invokers:{track:{funcName:"fisher.frameTracker.stereo.track",args:["{that}","{arguments}.0","{arguments}.1"]}}}),fisher.frameTracker.stereo.track=function(a,b,c){var d=a.leftRegion.motionIndex(b,c),e=a.rightRegion.motionIndex(b,c);a.events.onMotionUpdate.fire(d,e)}}();